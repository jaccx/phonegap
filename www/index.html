<html>
<body>
<button onclick="sendSignal()">Send signal</button>
<button onclick="startRecording()">Start recording</button>
<button onclick="stopRecording()">Stop recording</button>
<br>
<div id="videos">
<div id="consoleDiv" style = "width:80%; height:50%; overflow:auto; font-family:monospace"></div>
<script src="//static.opentok.com/webrtc/v2/js/opentok.js"></script>
<script>
var session,
    openTokSessionInfo,
    apiKey,
    sessionId,
    token,
    archiveId;
/*
See https://github.com/opentok/learning-opentok-php.
 
Set SAMPLE_SERVER_BASE_URL to the base URL of the web server that implements
the OpenTok PHP Getting Started Sample code (see the main README file.) This
web service handles some OpenTok-related API calls, related to obtaining
session IDs and tokens, and for working with archives.
*/
var sampleServerBaseUrl = '',
    sessionCredentialsUrl = sampleServerBaseUrl + '/session',
    startArchiveUrl = sampleServerBaseUrl + '/start/',
    stopArchiveUrl = sampleServerBaseUrl + '/stop/';
var apiKey,
  sessionId,
  token;

getApiKeyAndToken();
function getApiKeyAndToken() {
  var xhr = new XMLHttpRequest();
  xhr.open("GET", sessionCredentialsUrl, true);
  xhr.onload = function (e) {
    if (xhr.readyState === 4) {
      if (xhr.status === 200) {
        openTokSessionInfo = JSON.parse(xhr.responseText);
        //apiKey = openTokSessionInfo.apiKey;
        apiKey = "45942392";
        //sessionId = openTokSessionInfo.sessionId;
        sessionId = "1_MX40NTk0MjM5Mn5-MTUwMzIzODQwMzIwOX5zMDQxRTVUL09JMXRIcUxNdHc1dDQ5SXh-UH4";
        //token = openTokSessionInfo.token;
        token = "T1==cGFydG5lcl9pZD00NTk0MjM5MiZzaWc9ZTgyOWI1Y2QyZTRjYWNkNGFiYzNhMjk0MGY1MDAzZTNkYzEwMWMzMjpzZXNzaW9uX2lkPTFfTVg0ME5UazBNak01TW41LU1UVXdNekl6T0RRd016SXdPWDV6TURReFJUVlVMMDlKTVhSSWNVeE5kSGMxZERRNVNYaC1VSDQmY3JlYXRlX3RpbWU9MTUwMzIzODU4NiZub25jZT0wLjY5NTY0Mzc1ODY5NTgxNDQmcm9sZT1wdWJsaXNoZXImZXhwaXJlX3RpbWU9MTUwMzg0MzM3NiZjb25uZWN0aW9uX2RhdGE9ZGVtbyZpbml0aWFsX2xheW91dF9jbGFzc19saXN0PQ==";
        initSession();
      } else {
        console.error(xhr.statusText);
      }
    }
  };
  xhr.onerror = function (e) {
    console.error(xhr.statusText);
  };
  xhr.send(null);
}
function initSession() {
  session = OT.initSession(apiKey, sessionId);
  session.on('streamCreated', function(event) {
    session.subscribe(event.stream, 'videos', {insertMode:'append'});
  });
  
  session.on('archiveStarted', function(event) {
    archiveId = event.id;
    console.log('archiveStarted: ' + archiveId);
  });
  session.on('archiveStopped', function(event) {
    console.log('archiveStopped: ' + event.id)
  });
  session.on('signal:chat', function(event) {
    console.log(event.data);
  });
  session.connect(token, function (error) {
    if (!error) {
      var publisher = OT.initPublisher('videos', {insertMode:'append'});
      session.publish(publisher);
      publisher.publishAudio(false);
    }
  });
}
function sendSignal() {
  session.signal({
    type:'chat',
    data:'hello ' + new Date().toString()
  });
}
function stopRecording() {
  var xhr = new XMLHttpRequest();
  xhr.open("GET", stopArchiveUrl + archiveId, true);
  xhr.onload = function (e) {
    if (xhr.readyState === 4) {
      if (xhr.status === 200) {
        console.log(xhr.responseText);
      } else {
        console.error(xhr.statusText);
      }
    }
  };
  xhr.onerror = function (e) {
    console.error(xhr.statusText);
  };
  xhr.send(null);
}
function startRecording() {
  var xhr = new XMLHttpRequest();
  xhr.open("GET", startArchiveUrl, true);
  xhr.onload = function (e) {
    if (xhr.readyState === 4) {
      if (xhr.status === 200) {
        console.log(xhr.responseText);
      } else {
        console.error(xhr.statusText);
      }
    }
  };
  xhr.onerror = function (e) {
    console.error(xhr.statusText);
  };
  xhr.send(null);
}
console.log = function(str) {
  var consoleDiv = document.getElementById('consoleDiv');
  consoleDiv.innerHTML += str + "<br>";
  consoleDiv.scrollTop = consoleDiv.scrollHeight;
}
</script>
</body>
</html>